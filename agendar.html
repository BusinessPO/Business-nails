<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Agendar cita</title>
<style>
  body {
    font-family: Arial, sans-serif;
    padding: 20px;
    background: #f5f5f5;
    text-align: center;
  }
  table {
    margin: 0 auto;
    border-collapse: collapse;
    width: 95%;
  }
  th, td {
    border: 1px solid #999;
    padding: 8px;
    text-align: center;
  }
  th {
    background-color: #007bff;
    color: white;
  }
  td.horario {
    cursor: pointer;
    border-radius: 6px;
    color: white;
    font-weight: bold;
  }
  td.disponible {
    background-color: #28a745;
  }
  td.ocupado {
    background-color: gray;
    cursor: not-allowed;
    color: #ccc;
  }
  td.no-laboral {
    background-color: #eee;
    color: #aaa;
    cursor: default;
  }
  h1 {
    margin-bottom: 15px;
  }
</style>
</head>
<body>

<h1>Selecciona fecha y horario</h1>

<table id="tablaCitas">
  <thead>
    <tr>
      <th>Fecha</th>
      <th>Horarios (10:00 - 18:00)</th>
    </tr>
  </thead>
  <tbody>
    <!-- Se llenará con JS -->
  </tbody>
</table>

<script>
  const tablaBody = document.querySelector("#tablaCitas tbody");

  // Función para saber si día es fin de semana
  function esFinDeSemana(fecha) {
    const dia = fecha.getDay();
    return dia === 0 || dia === 6;
  }

  // Función para formatear fecha dd/mm/aaaa
  function formatearFecha(fecha) {
    return fecha.toLocaleDateString("es-MX", { weekday:"short", day:"numeric", month:"numeric" });
  }

  // Obtener citas ocupadas (desde localStorage)
  const citasAgendadas = JSON.parse(localStorage.getItem("citasAgendadas") || "[]");

  // Generar fechas desde 3 días después, 14 días (solo lunes-viernes)
  function generarFechas(desde, cantidad) {
    const fechas = [];
    let fecha = new Date(desde);
    while (fechas.length < cantidad) {
      if (!esFinDeSemana(fecha)) {
        fechas.push(new Date(fecha));
      }
      fecha.setDate(fecha.getDate() + 1);
    }
    return fechas;
  }

  const hoy = new Date();
  const inicio = new Date(hoy.getFullYear(), hoy.getMonth(), hoy.getDate() + 3);
  const fechas = generarFechas(inicio, 14);

  // Horarios disponibles (hora inicio)
  const horarios = ["10:00", "11:00", "12:00", "13:00", "14:00", "15:00", "16:00", "17:00", "18:00"];

  fechas.forEach(fecha => {
    const fila = document.createElement("tr");

    // Columna fecha
    const tdFecha = document.createElement("td");
    tdFecha.textContent = formatearFecha(fecha);
    fila.appendChild(tdFecha);

    // Columna horarios
    const tdHorarios = document.createElement("td");

    horarios.forEach(hora => {
      const span = document.createElement("span");
      span.textContent = hora;
      span.classList.add("horario");

      // Verificar si horario está ocupado
      const fechaStr = fecha.toISOString().slice(0,10);
      const estaOcupado = citasAgendadas.some(cita => cita.fecha === fechaStr && cita.hora === hora);

      if(estaOcupado) {
        span.classList.add("ocupado");
        span.title = "Horario ocupado";
      } else {
        span.classList.add("disponible");
        span.title = "Horario disponible";
        span.style.margin = "0 4px";
        span.style.padding = "6px 12px";
        span.style.display = "inline-block";
        span.style.borderRadius = "6px";
        span.style.cursor = "pointer";

        span.addEventListener("click", () => {
          // Guardar selección temporal y redirigir a registro
          localStorage.setItem("citaSeleccionada", JSON.stringify({ fecha: fechaStr, hora }));
          window.location.href = "registro.html";
        });
      }
      tdHorarios.appendChild(span);
    });

    fila.appendChild(tdHorarios);
    tablaBody.appendChild(fila);
  });
</script>

</body>
</html>
